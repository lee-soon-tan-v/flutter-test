<!-- assets/html/index.html -->
<!DOCTYPE html>
<html>
<head>
  <title>WebView SPA</title>
</head>
<body>
	Handles the back button and invoke proper exit-app function
  <div id="content">Home</div>

  <button onclick="navigate('#/banner-1')">Go to Banner 1</button>
  <button onclick="navigate('#/banner-2')">Go to Banner 2</button>
  <button onclick="navigate('#/')">Go to Home</button>

  <script>
  let currentHistory = [];
  let pendingPromiseRequests = {};
  let currentHistoryLength = 0;
  let isBackButtonInvoked = false;
  
    function navigate(hash) {
      window.location.hash = hash;
    }

    function render(data) {
		// New navigation
		if(!isBackButtonInvoked){
      alert(window.location.hash)
			currentHistoryLength = history.length;
      alert('new');
      //alert('arr len: ' + currentHistory.length);
			currentHistory.push(window.location.hash);console.log('push' + window.location.hash)
      alert('arr content: ' + JSON.stringify(currentHistory));
		}else{
      // Check for 'HOME' route (HOME -> Other Pages -> Home -> backbutton())
      if(currentHistory.at(-1) === '#/'){
				if(currentHistory.at(-2) === '#/') {
          alert('cond1');
					currentHistory.pop();
          requestToExit();
          isBackButtonInvoked = false;
				} else {
          // Redirect back to home
					window.location.hash = "#/";
          currentHistory.push('#/');
				}
				return;
			}
      alert('pop');
      currentHistory.pop();
		}
    const content = document.getElementById('content');

	  console.log('rendering + ' + window.location.hash);
      switch(window.location.hash) {
        case '#/banner-1':
          content.innerHTML = 'Banner 1';
          break;
        case '#/banner-2':
          content.innerHTML = 'Banner 2';
          break;
        default:
          content.innerHTML = 'Home';
      }
    }

    // Handle hash changes from back button
    window.addEventListener('hashchange', render);
	
	//currentHistory.push('#/');
    navigate('#/');



    // Message send to Flutter
    function send(msg){
      try {
        //alert("Sending: " + msg);
	      sendToFlutter.postMessage(msg);
      } catch (e) {
        console.warn("sendToFlutter not available:", e);
      }
    }

    async function sendToFlutterWithPromise(json){
      return new Promise((resolve, reject) => {
        json.id = crypto.randomUUID();
        pendingPromiseRequests[json.id] = { resolve, reject };
        send(JSON.stringify(json));
      });
    }

    // Message received from Flutter
    function sendToWebView(msg) {
      //alert("Flutter replied: " + JSON.stringify(msg));

      if(typeof msg === 'object') {
        if(msg?.action === 'confirm-dialog' && msg?.id){
          pendingPromiseRequests[msg.id]?.resolve(msg);
        }else if(msg?.action === 'get-ui' && msg?.fileName && msg?.data && msg?.id){
          pendingPromiseRequests[msg.id]?.resolve(msg);
        }
      }
    
      console.log("Flutter replied:", msg);
    }

  function requestToExit () {
    sendToFlutterWithPromise({
				'action': 'confirm-dialog',
				'title': 'Exit Alert',
				'content': 'Do you want to exit?',
				'okText': 'YES',
				'cancelText': 'NO',
			}).then(data => data.confirm ? send(JSON.stringify({'action': 'exit'})) : null);
  }

  function backButton(){
    isBackButtonInvoked = true;
    if (window.history.length > 1) {
      window.history.back();
      // Condition for Home -> Other Pages -> BackButton() -> Home -> BackButton()
      if(currentHistory.length === 1){
        alert('cond3');
        requestToExit();
        isBackButtonInvoked = false;
      }
    } else {
      // Condition for Home -> BackButton()
      alert('cond2');
      requestToExit();
      isBackButtonInvoked = false;
    }
  }
	
  </script>
</body>
</html>
